<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Info Dashboard</title>

    <!-- websocket ì‚¬ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- TradingView ì°¨íŠ¸ ë¡œë“œ -->
    <!-- Lightweight Charts ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>

    <!-- FontAwesome ì•„ì´ì½˜ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!--Google Fonts-->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;300;400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #EDEEF1;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .navbar {
            background-color: #4e73df;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
            padding: 15px 30px;
            color: white;
        }

        .navbar .brand {
            font-size: 1.0rem;
            font-weight: 800;  /* êµµê¸° ìµœëŒ€ê°’ */
            text-transform: uppercase;
            font-family: 'Nunito', sans-serif !important;
            text-align: left;
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            margin-left: 10px;
        }


        .navbar .icons {
            display: flex;
            align-items: center;
            margin-left: auto;
            gap: 10px;
        }

        .navbar .icons i {
            font-size: 1.0rem;
            cursor: pointer;
            color: white;
            position: relative;
        }

        /* ì•ŒëŒ ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .badge {
            position: absolute;
            top: -3px;
            right: -5px;
            background: red;
            color: white;
            font-size: 0.5rem;
            padding: 2px 4px;
            border-radius: 50%;
            font-weight: bold;
        }

        /* ì„¸ë¡œ êµ¬ë¶„ì„  */
        .divider {
            height: 25px;
            width: 2px;
            background-color: white;
            margin: 0 15px;
        }

        /* ìœ ì € í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .user-text {
            font-size: 0.8rem;
            color: #ffffff; /* í°ìƒ‰ ìœ ì§€ */
        }

        /* ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        @media (max-width: 480px) {
            .navbar .brand {
                text-align: left !important; /* ê°•ì œ ì™¼ìª½ ì •ë ¬ */
            }
        }

    </style>
</head>
<body class="bg-gray-100">
<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="navbar">
    <div class="brand">
        <a href="/index.html" style="text-decoration: none; color: inherit;">Coinfo</a>
    </div>
    <div class="icons">
        <!-- ì•ŒëŒ ì•„ì´ì½˜ (ë°°ì§€ í¬í•¨) -->
        <div style="position: relative; cursor: pointer;" onclick="location.href='/alert/alarm.html'">
            <i class="fas fa-bell"></i>
            <span class="badge">2+</span>
        </div>

        <!-- ì„¸ë¡œ êµ¬ë¶„ì„  -->
        <div class="divider"></div>

        <!-- ìœ ì € í”„ë¡œí•„ (í…ìŠ¤íŠ¸ í¬í•¨) -->
        <span class="user-text" id="user-email"></span>
        <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì•„ì´ì½˜ -->
        <i id="auth-icon" class="fas" style="color: white; font-size: 30px; cursor: pointer;"></i>

    </div>
</nav>

<div class="container mx-auto p-6 grid grid-cols-3 gap-6">
    <!-- ì½”ì¸ ì°¨íŠ¸ ë°•ìŠ¤ -->
    <div class="bg-white p-3 rounded-lg shadow h-[23rem] col-span-2">
        <div class="flex items-center space-x-4">
            <img id="coin-logo" src="" alt="" class="w-10 h-10">
            <h2 class="text-xl font-bold"><span id="coin-name"></span> (<span id="coin-ticker"></span>) <span id="current-price">-</span></h2>
        </div>
        <div id="tradingview-chart" style="width: 100%; height: 500px;"></div>
    </div>

    <!-- ë™í–¥ ë¶„ì„ ë°•ìŠ¤ -->
    <div class="bg-white p-3 rounded-lg shadow min-h-72 md:min-h-80 flex flex-col items-center justify-start pt-6 col-span-1">
        <h2 class="text-xl font-bold">ìµœê·¼ ë™í–¥ íë¦„ ë¶„ì„</h2>
        <div class="text-center mt-7">
            <div id="emotion-display" class="text-5xl"></div>
            <p id="emotion-text" class="text-sm text-gray-500 mt-1"></p> <!-- ì‘ì€ ê¸€ì”¨ ì¶”ê°€ -->
        </div>
        <div class="flex justify-center space-x-8 mt-10 w-full">
            <span class="text-3xl">ğŸ˜¢</span>
            <span class="text-3xl">ğŸ˜</span>
            <span class="text-3xl">ğŸ˜</span>
            <span class="text-3xl">ğŸ˜Š</span>
            <span class="text-3xl">ğŸ˜ƒ</span>
        </div>
    </div>

    <!-- ë‰´ìŠ¤ ë°•ìŠ¤ -->
    <div class="bg-white p-4 rounded-lg shadow h-72 col-span-2">
        <h2 class="text-xl font-bold">ë‰´ìŠ¤ ëª©ë¡</h2>
        <div class="news-box mt-2">
            <!-- ë‰´ìŠ¤ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ë¶€ë¶„ -->
        </div>
    </div>

    <!-- ì½”ì¸ ì •ë³´ ë°•ìŠ¤ -->
    <div class="bg-white p-4 rounded-lg shadow h-auto col-span-1">
        <h2 class="text-xl font-bold">ì½”ì¸ ê´€ë ¨ ì¼ì •</h2>
        <div id="coin-gpt-data">
            <p><strong>í¬ë¦¬ìŠ¤ë§ˆìŠ¤:</strong> ë™ì‹¬ìœ¼ë¡œ ëŒì•„ê°€ ì¼í™•ì²œê¸ˆì„ ê¿ˆê¾¸ëŠ” ì‚¬ëŒë“¤ë¡œ ì¸í•´ ì½”ì¸ ê°’ì´ ì¹˜ì†ŸëŠ”ë‹¤.</p>
        </div>
    </div>
</div>


<script>

    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const coinName = urlParams.get("name");
        const coinTicker = urlParams.get("ticker");

        // Upbit WebSocket ìŠ¤í¬ë¦½íŠ¸ì— ì½”ì¸ í‹°ì»¤ ì „ë‹¬
        const script = document.createElement("script");
        //script.src = `../js/upbit_websocket.js`;
        script.src = `../js/detail_front.js`;
        script.dataset.ticker = coinTicker;
        document.body.appendChild(script);
        logo = `${coinTicker}`.replace("KRW-","");
        if (coinName && coinTicker) {
            document.getElementById("coin-logo").src = `https://static.upbit.com/logos/${logo}.png`;
            document.getElementById("coin-logo").alt = coinName;
            document.getElementById("coin-name").textContent = coinName;
            document.getElementById("coin-ticker").textContent = `KRW-${coinTicker}`;

            fetch(`/api/coin/details/${coinName}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("ì½”ì¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("api ì‘ë‹µê°’: "+JSON.stringify(data, null, 2));

                    // ì½”ì¸ ê´€ë ¨ ì¼ì •(gptData) ì‚½ì…
                    const coinGptData = document.getElementById("coin-gpt-data");
                    if (coinGptData && data.coin.gptData) {
                        coinGptData.innerHTML = `<p>${data.coin.gptData}</p>`;
                    }

                    //ê°ì„±ë¶„ì„
                    const emotionDisplay = document.getElementById("emotion-display");
                    const emotionText = document.getElementById("emotion-text");
                    const prospects = data.coin.prospects;

                    if (prospects < -3) {
                        emotionDisplay.textContent = "ğŸ˜¢";
                        emotionText.textContent = "ë§¤ìš° ë¶€ì •ì ";
                    } else if (prospects >= -3 && prospects < 0) {
                        emotionDisplay.textContent = "ğŸ˜";
                        emotionText.textContent = "ë‹¤ì†Œ ë¶€ì •ì ";
                    } else if (prospects === 0) {
                        emotionDisplay.textContent = "ğŸ˜";
                        emotionText.textContent = "ì¤‘ë¦½";
                    } else if (prospects > 0 && prospects <= 3) {
                        emotionDisplay.textContent = "ğŸ˜Š";
                        emotionText.textContent = "ê¸ì •ì ";
                    } else if (prospects > 3) {
                        emotionDisplay.textContent = "ğŸ˜ƒ";
                        emotionText.textContent = "ë§¤ìš° ê¸ì •ì ";
                    }

                    //ë‰´ìŠ¤
                    const newsContainer = document.querySelector(".news-box");

                    if (!newsContainer) {
                        console.error("ğŸš¨ .news-box ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                        return;
                    }

                    //ë‰´ìŠ¤ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
                    if (!data.newsList || data.newsList.length === 0) {
                        newsContainer.innerHTML = "<p class='text-gray-600'>ê´€ë ¨ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                        return;
                    }

                    // ë‰´ìŠ¤ ëª©ë¡ ë™ì  ìƒì„±
                    newsContainer.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

                    data.newsList.forEach(news => {
                        const newsItem = document.createElement("div");
                        newsItem.classList.add("mt-2", "border-b", "pb-2");

                        // âœ… ë‚ ì§œ ë³€í™˜ (ISO -> í•œêµ­ ì‹œê°„ í¬ë§·)
                        const formattedDate = new Date(news.uploadTime).toLocaleString("ko-KR", {
                            year: "numeric",
                            month: "2-digit",
                            day: "2-digit",
                            hour: "2-digit",
                            minute: "2-digit",
                            second: "2-digit"
                        });

                        newsItem.innerHTML = `
                            <h3 class="font-semibold">
                                <a href="${news.source}" target="_blank" class="text-blue-600 hover:underline">${news.title}</a>
                            </h3>
                            <p class="text-sm text-gray-600">By ${news.newspaper} Â· ${formattedDate}</p>
                        `;

                        newsContainer.appendChild(newsItem);
                    });
                })
                .catch(error => {
                    console.error("ğŸš¨ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    const newsContainer = document.querySelector(".news-box");
                    if (newsContainer) {
                        newsContainer.innerHTML = "<p class='text-gray-600'>ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
                    }
                });
        } else {
            document.getElementById("coin-info").textContent = "ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.";
        }
    });

    //ë¡œê·¸ì¸ í™•ì¸
    async function checkUserLogin() {
        try {
            const response = await fetch('/api/user/email'); // ë°±ì—”ë“œì—ì„œ ì´ë©”ì¼ ê°€ì ¸ì˜¤ê¸°
            const email = await response.text(); // ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜

            const userText = document.getElementById("user-email");
            const authIcon = document.getElementById("auth-icon");

            if (email.trim()) {
                // ë¡œê·¸ì¸ ìƒíƒœ â†’ ì´ë©”ì¼ í‘œì‹œ
                userText.textContent = email;
            } else {
                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ â†’ ë¡œê·¸ì¸ ë²„íŠ¼ í™œì„±í™”
                userText.textContent = "";
                authIcon.classList.add("fa-sign-in-alt"); // ğŸšª ë“¤ì–´ê°€ëŠ” ì•„ì´ì½˜ (ë¡œê·¸ì¸)

                authIcon.onclick = function() {
                    location.href = "/login.html"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                };
            }
        } catch (error) {
            console.error("ğŸš¨ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    checkUserLogin(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰

</script>

</body>
</html>