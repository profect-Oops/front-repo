<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coinfo</title>

    <!-- FontAwesome ì•„ì´ì½˜ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!--Google Fonts-->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;300;400;600;700;800;900&display=swap" rel="stylesheet">


    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #EDEEF1;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .navbar {
            background-color: #4e73df;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
            padding: 15px 30px;
            color: white;
        }

        .navbar .brand {
            font-size: 1.0rem;
            font-weight: 800;  /* êµµê¸° ìµœëŒ€ê°’ */
            text-transform: uppercase;
            font-family: 'Nunito', sans-serif !important;
            text-align: left;
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            margin-left: 10px;
        }


        .navbar .icons {
            display: flex;
            align-items: center;
            margin-left: auto;
            gap: 10px;
        }

        .navbar .icons i {
            font-size: 1.0rem;
            cursor: pointer;
            color: white;
            position: relative;
        }

        /* ì•ŒëŒ ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .badge {
            position: absolute;
            top: -3px;
            right: -5px;
            background: red;
            color: white;
            font-size: 0.5rem;
            padding: 2px 4px;
            border-radius: 50%;
            font-weight: bold;
        }

        /* ì„¸ë¡œ êµ¬ë¶„ì„  */
        .divider {
            height: 25px;
            width: 2px;
            background-color: white;
            margin: 0 15px;
        }

        /* ìœ ì € í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .user-text {
            font-size: 0.8rem;
            color: #ffffff; /* í°ìƒ‰ ìœ ì§€ */
        }

        /* í”„ë¡œí•„ ì´ë¯¸ì§€ */
        .profile {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: white;
            object-fit: cover;
        }

        /* ì¹´ë“œ ì»¨í…Œì´ë„ˆ */
        .card-container {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 30px;
            padding: 30px;
        }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card {
            position: relative;
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 25px;
            border-radius: 6px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 60px;
            border-left: 5px solid var(--card-border-color);; /* ì™¼ìª½ ë°” */
        }


        /* ì¹´ë“œë³„ ê°œë³„ ìƒ‰ìƒ ì„¤ì • */
        .card.total {
            --card-border-color: #4e73df;
            color: #4e73df;
        }
        .card.on {
            --card-border-color: #1cc88a;
            color: #1cc88a;
        }
        .card.off {
            --card-border-color: #36b9cc;
            color: #36b9cc;
        }

        /* ì¹´ë“œ ë‚´ë¶€ ì œëª© ìŠ¤íƒ€ì¼ */
        .card h3 {
            font-size: 0.7rem;
            font-weight: 700;
            color: inherit; /* ì¹´ë“œ ìƒ‰ìƒê³¼ ë™ì¼í•˜ê²Œ */
        }

        /* ìˆ«ì ìŠ¤íƒ€ì¼ */
        .card p {
            font-size: 1.4rem;
            font-weight: bold;
            color: #5A5C69;
            margin-top: -10px; /* ê¸°ì¡´ë³´ë‹¤ ìœ„ ì—¬ë°± ì¤„ì´ê¸° */
        }

        /* ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ (ì˜¤ë¥¸ìª½ ì¤‘ì•™ ì •ë ¬) */
        .card i {
            position: absolute;
            right: 20px; /* ì¹´ë“œì˜ ì˜¤ë¥¸ìª½ì—ì„œ ê°„ê²© ì¡°ì • */
            top: 50%; /* ë¶€ëª¨ ìš”ì†Œ ê¸°ì¤€ ì„¸ë¡œ ì¤‘ì•™ */
            transform: translateY(-50%); /* ì •í™•í•œ ì¤‘ì•™ ì •ë ¬ */
            font-size: 35px;
            color: #DDDFEB;
        }

        /* ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .edit-button, .delete-button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .edit-button {
            background-color: #4e73df;
            color: white;
            margin-right: 5px;
        }

        .delete-button {
            background-color: #e74a3b;
            color: white;
        }

        /* ì•Œë¦¼ ì„¤ì • ë°•ìŠ¤ */
        .settings-container {
            background-color: #4e73df;
            padding: 25px;
            border-radius: 6px;
            color: white;
            margin-right: 30px;
            margin-left: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .settings-container .label {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* ì•Œë¦¼ ì„¤ì • ì œëª© (ì™¼ìª½ ì •ë ¬) */
        .settings-container .input-group {
            display: flex;
            text-align: left; /* ì™¼ìª½ ì •ë ¬ */
        }

        /* ì…ë ¥ í•„ë“œì™€ ë²„íŠ¼ ê·¸ë£¹ */
        .settings-container .input-group-wrapper {
            display: flex;
            align-items: center;
            justify-content: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
            gap: 15px; /* ìš”ì†Œ ê°„ ê°„ê²© */
            flex-wrap: wrap; /* ë°˜ì‘í˜•ì„ ìœ„í•´ ì¤„ë°”ê¿ˆ í—ˆìš© */
        }

        .settings-container .input-group {
            display: flex;
            align-items: center;
        }

        .settings-container .input-group label {
            margin-right: 10px;
        }

        .settings-container input {
            padding: 10px;
            border: none;
            border-radius: 5px;
            width: 200px;
            margin-right: 10px;
        }

        .settings-container button {
            background: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            margin: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }

        th {
            background-color: #4e73df;
            color: white;
        }

        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        /* ì²´í¬ë°•ìŠ¤ ìˆ¨ê¸°ê¸° */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* ìŠ¬ë¼ì´ë” ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        /* ì²´í¬ ìƒíƒœì—ì„œì˜ ë°°ê²½ìƒ‰ */
        input:checked + .slider {
            background-color: #4e73df;
        }

        /* ìŠ¬ë¼ì´ë” ë‚´ë¶€ ì› */
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        /* ì²´í¬ ìƒíƒœì—ì„œ ì›ì˜ ìœ„ì¹˜ ì´ë™ */
        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* ë‘¥ê·¼ ìŠ¤íƒ€ì¼ */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        @media (max-width: 768px) {
            .settings-container {
                flex-direction: column;
                text-align: center;
            }

            .settings-container .input-group {
                flex-direction: column;
                margin-bottom: 10px;
            }

            .settings-container input {
                width: 100%;
            }
        }

        /* ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        @media (max-width: 480px) {
            .navbar .brand {
                text-align: left !important; /* ê°•ì œ ì™¼ìª½ ì •ë ¬ */
            }
        }

        /* ë°˜ì‘í˜•: í™”ë©´ì´ ì‘ì•„ì§ˆ ê²½ìš° ì¹´ë“œ ì¤„ë°”ê¿ˆ */
        @media (max-width: 768px) {
            .card-container {
                flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ */
            }
        }

    </style>
</head>
<body>

<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="navbar">
    <div class="brand">
        <a href="/index.html" style="text-decoration: none; color: inherit;">Coinfo</a>
    </div>
    <div class="icons">
        <!-- ì•ŒëŒ ì•„ì´ì½˜ (ë°°ì§€ í¬í•¨) -->
        <div style="position: relative; cursor: pointer;" onclick="location.href='/alarm.html'">
            <i class="fas fa-bell"></i>
            <span class="badge">2+</span>
        </div>

        <!-- ì„¸ë¡œ êµ¬ë¶„ì„  -->
        <div class="divider"></div>

        <!-- ìœ ì € í”„ë¡œí•„ (í…ìŠ¤íŠ¸ í¬í•¨) -->
        <span class="user-text" id="user-email"></span>
        <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì•„ì´ì½˜ -->
        <i id="auth-icon" class="fas" style="color: white; font-size: 30px; cursor: pointer;"></i>

    </div>
</nav>

<!-- ì¹´ë“œ ì„¹ì…˜ -->
<div class="card-container">
    <div class="card total">
        <h3>ì´ ì•ŒëŒ ê°œìˆ˜ (TOTAL)</h3>
        <p id="total-alerts">- ê°œ</p> <!-- ë™ì  ë°ì´í„° ì—…ë°ì´íŠ¸ -->
        <i class="fas fa-list-alt"></i>
    </div>
    <div class="card on">
        <h3>ì•ŒëŒ ON</h3>
        <p id="active-alerts">- ê°œ</p> <!-- ë™ì  ë°ì´í„° ì—…ë°ì´íŠ¸ -->
        <i class="fas fa-bell"></i>
    </div>
    <div class="card off">
        <h3>ì•ŒëŒ OFF</h3>
        <p id="inactive-alerts">- ê°œ</p> <!-- ë™ì  ë°ì´í„° ì—…ë°ì´íŠ¸ -->
        <i class="fas fa-bell-slash"></i>
    </div>
</div>

<!-- ì•Œë¦¼ ì„¤ì • -->
<div class="settings-container">
    <!-- ì™¼ìª½ ì •ë ¬: ì•Œë¦¼ ì„¤ì • í…ìŠ¤íŠ¸ -->
    <div class="label">ì•Œë¦¼ ì„¤ì •</div>

    <!-- ì˜¤ë¥¸ìª½ ì •ë ¬: ì…ë ¥ í•„ë“œì™€ ë²„íŠ¼ -->
    <div class="input-group-wrapper">
        <div class="input-group">
            <label>ì¢…ëª©:</label>
            <input type="text" id="stock-search" placeholder="ê²€ìƒ‰">
        </div>
        <div class="input-group">
            <label>ê°€ê²©:</label>
            <input type="text" id="price-search" placeholder="ê²€ìƒ‰">
        </div>
        <button id="saveAlertButton">ì„¤ì •</button>
    </div>
</div>

<!-- ì½”ì¸ ì•ŒëŒ ëª©ë¡ -->
<div class="table-container">
    <h2>ì½”ì¸ ì•ŒëŒ ëª©ë¡</h2>
    <table>
        <thead>
        <tr>
            <th>ì½”ì¸ ì´ë¦„</th>
            <th>ì•Œë¦¼ ì„¤ì • ê°€ê²©</th>
            <th>ì•Œë¦¼ ì„¤ì •</th>
            <th>ìˆ˜ì •</th>
            <th>ì‚­ì œ</th>
        </tr>
        </thead>
        <tbody id="coin-table">
        </tbody>
    </table>
</div>

<script>

    const backendBaseUrl = "http://localhost:8080";  // EC2 í¼ë¸”ë¦­ IP ë˜ëŠ” ë„ë©”ì¸ ì…ë ¥
    

    // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ì•Œë¦¼ ë°ì´í„°ë¥¼ ì¡°íšŒ
    window.addEventListener("DOMContentLoaded", async function() {
        try {
            // ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ & ì•Œë¦¼ ê°œìˆ˜ ì¡°íšŒë¥¼ ë³‘ë ¬ë¡œ ì‹¤í–‰í•˜ì—¬ ì„±ëŠ¥ ìµœì í™”
            const [alertResponse, countResponse] = await Promise.all([
                fetch(`${backendBaseUrl}/api/alert/read`, { // ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include" // ì„¸ì…˜ ìœ ì§€
                }),
                fetch(`${backendBaseUrl}/api/alert/count`, { // ì´ ì•Œë¦¼ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include"
                })
            ]);

            const alertData = await alertResponse.json();
            const countData = await countResponse.json();

            // ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ ë°ì´í„° ì‚½ì…
            if (alertData.result.code === "0000") {
                populateTable(alertData.data);
            } else {
                alert("ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }

            // ì•Œë¦¼ ê°œìˆ˜ ë°ì´í„° ì‚½ì…
            if (countData.total !== undefined) {
                document.getElementById("total-alerts").textContent = `${countData.total}ê°œ`;
                document.getElementById("active-alerts").textContent = `${countData.on}ê°œ`;
                document.getElementById("inactive-alerts").textContent = `${countData.off}ê°œ`;
            } else {
                console.warn("ì•Œë¦¼ ê°œìˆ˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }

        } catch (error) {
            console.error("ì•Œë¦¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ì•Œë¦¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });

    // ì•ŒëŒ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateAlertCounts() {
        fetch(`${backendBaseUrl}/api/alert/count`, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
            credentials: "include"
        })
            .then(response => response.json())
            .then(countData => {
                document.getElementById("total-alerts").textContent = `${countData.total}ê°œ`;
                document.getElementById("active-alerts").textContent = `${countData.on}ê°œ`;
                document.getElementById("inactive-alerts").textContent = `${countData.off}ê°œ`;
            })
            .catch(error => console.error("ì•ŒëŒ ê°œìˆ˜ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error));
    }


    // í…Œì´ë¸”ì— ì•Œë¦¼ ë°ì´í„° ì‚½ì…
    function populateTable(alerts) {
        const tableBody = document.getElementById("coin-table");
        // í…Œì´ë¸” ì´ˆê¸°í™”
        tableBody.innerHTML = "";

        console.log("API ì‘ë‹µ ë°ì´í„°:", alerts);

        alerts.forEach(alert => {
            const row = document.createElement("tr");

            // ì½”ì¸ ì´ë¦„
            const coinNameCell = document.createElement("td");
            coinNameCell.textContent = alert.coin.name;

            // ì•Œë¦¼ ê°€ê²©
            const alertPriceCell = document.createElement("td");
            alertPriceCell.textContent = `â‚©${alert.alertPrice.toLocaleString()}`; // ìˆ«ì í¬ë§· ì ìš©

            // ì•Œë¦¼ ì„¤ì • (ìŠ¤ìœ„ì¹˜)
            const alertActiveCell = document.createElement("td");
            const switchLabel = document.createElement("label");
            switchLabel.classList.add("switch");

            const switchInput = document.createElement("input");
            switchInput.type = "checkbox";
            switchInput.checked = alert.alertActive; // ì•Œë¦¼ í™œì„±í™” ì—¬ë¶€
            switchInput.setAttribute("data-alert-id", alert.alertId); // alertId ì €ì¥

            const switchSpan = document.createElement("span");
            switchSpan.classList.add("slider", "round");

            switchLabel.appendChild(switchInput);
            switchLabel.appendChild(switchSpan);
            alertActiveCell.appendChild(switchLabel);

            // ìˆ˜ì • ë²„íŠ¼
            const editButton = document.createElement("button");
            editButton.textContent = "ìˆ˜ì •";
            editButton.classList.add("edit-button");
            editButton.setAttribute("data-alert-id", alert.alertId);

            // ì‚­ì œ ë²„íŠ¼
            const deleteButton = document.createElement("button");
            deleteButton.textContent = "ì‚­ì œ";
            deleteButton.classList.add("delete-button");
            deleteButton.setAttribute("data-alert-id", alert.alertId);

            // ìˆ˜ì • ë²„íŠ¼ ì…€
            const editCell = document.createElement("td");
            editCell.appendChild(editButton);

            // ì‚­ì œ ë²„íŠ¼ ì…€
            const deleteCell = document.createElement("td");
            deleteCell.appendChild(deleteButton);

            // í…Œì´ë¸”ì— í–‰ ì¶”ê°€
            row.appendChild(coinNameCell);
            row.appendChild(alertPriceCell);
            row.appendChild(alertActiveCell);
            row.appendChild(editCell);
            row.appendChild(deleteCell);
            tableBody.appendChild(row);
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ ì ìš©)
        tableBody.addEventListener("change", async function(event) {
            const switchInput = event.target;
            if (switchInput.type === "checkbox") {
                const alertId = switchInput.getAttribute("data-alert-id");
                const alertActive = switchInput.checked;

                try {
                    const response = await fetch(`${backendBaseUrl}/api/alert/update/${alertId}`, {
                        method: "PATCH",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ alertActive: alertActive })
                    });

                    const result = await response.json();

                    if (result.result.code === "0000") {
                        alert("âœ… ì•Œë¦¼ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        updateAlertCounts();
                    } else {
                        alert("âš ï¸ ì•Œë¦¼ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                } catch (error) {
                    console.error("âŒ ì•Œë¦¼ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:", error);
                    alert("âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì¸í•´ ì•Œë¦¼ ìƒíƒœë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            }
        });

        // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        tableBody.addEventListener("click", function(event) {
            if (event.target.classList.contains("edit-button")) {
                const alertId = event.target.getAttribute("data-alert-id");
                const row = event.target.closest("tr");
                const coinName = row.cells[0].textContent;
                const alertPrice = row.cells[1].textContent.replace("â‚©", "").replace(",", "");

                // ì…ë ¥ í•„ë“œì— ì•Œë¦¼ ì •ë³´ ì±„ìš°ê¸°
                document.getElementById("stock-search").value = coinName;
                document.getElementById("price-search").value = alertPrice;

                // ì¢…ëª© ì…ë ¥ë€ ë¹„í™œì„±í™”
                document.getElementById("stock-search").disabled = true;

                // ì €ì¥ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                document.getElementById("saveAlertButton").textContent = "ìˆ˜ì •";

                // ìˆ˜ì • ì¤‘ì¸ ì•Œë¦¼ì˜ IDë¥¼ ì €ì¥
                document.getElementById("saveAlertButton").setAttribute("data-alert-id", alertId);
            }
        });
    }

    //ì•Œë¦¼ ìƒì„± ë˜ëŠ” ìˆ˜ì •
    document.getElementById("saveAlertButton").addEventListener("click", async function() {

        const alertId = this.getAttribute("data-alert-id");

        if (alertId) {
            // ì•Œë¦¼ ìˆ˜ì • ë¡œì§
            const newAlertPrice = parseFloat(document.getElementById("price-search").value);

            try {
                const response = await fetch(`${backendBaseUrl}/api/alert/update/price/${alertId}`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ alertPrice: newAlertPrice }),
                    credentials: "include"
                });

                const result = await response.json();

                if (result.result.code === "0000") {
                    alert("ì•Œë¦¼ ê°€ê²©ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    // ìˆ˜ì •ëœ ì•Œë¦¼ ì •ë³´ë¡œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                    updateAlertInTable(alertId, newAlertPrice);
                } else {
                    alert("ì•Œë¦¼ ê°€ê²© ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error("ì•Œë¦¼ ê°€ê²© ìˆ˜ì • ì˜¤ë¥˜:", error);
                alert("ì•Œë¦¼ ê°€ê²© ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById("stock-search").value = "";
            document.getElementById("price-search").value = "";
            document.getElementById("stock-search").disabled = false;
            document.getElementById("saveAlertButton").textContent = "ì„¤ì •";
            document.getElementById("saveAlertButton").removeAttribute("data-alert-id");
        } else {
            //ì•Œë¦¼ ìƒˆë¡œ ì €ì¥
            const coinName = document.getElementById("stock-search").value; // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì¢…ëª© ê°’

            if (!coinName) {
                alert("ì½”ì¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                // ì•Œë¦¼ ì •ë³´ ìƒì„±
                const alertRequest = {
                    coinName: coinName,
                    alertPrice: parseFloat(document.getElementById("price-search").value), // ì•Œë¦¼ ê°€ê²© ì…ë ¥
                    alertActive: true // ì•Œë¦¼ í™œì„±í™” ì—¬ë¶€
                };

                // ì•Œë¦¼ ì €ì¥ ìš”ì²­
                const saveResponse = await fetch(`${backendBaseUrl}/api/alert/save`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(alertRequest),
                    credentials: "include" // ì„¸ì…˜ ìœ ì§€ë¥¼ ìœ„í•œ ì˜µì…˜
                });

                const saveResult = await saveResponse.json();

                if (saveResult.result.code === "0000") {//ì•Œë¦¼ ìƒì„±
                    alert("ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    // ìƒˆë¡œìš´ ì•Œë¦¼ ë°ì´í„° ìƒì„±
                    const newAlert = {
                        coinName: coinName,
                        alertPrice: alertRequest.alertPrice,
                        alertActive: true,
                        alertId: saveResult.data.alertId // ì„œë²„ì—ì„œ ìƒì„±ëœ alertId ì‚¬ìš©
                    };
                    updateAlertCounts();
                    addNewAlertToTable(newAlert); // ìƒˆë¡œìš´ ì•Œë¦¼ì„ í…Œì´ë¸”ì— ì¶”ê°€
                } else {
                    alert("ì•Œë¦¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("ì½”ì¸ ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById("stock-search").value = "";
            document.getElementById("price-search").value = "";
            document.getElementById("stock-search").disabled = false;
            document.getElementById("saveAlertButton").textContent = "ì„¤ì •";
            document.getElementById("saveAlertButton").removeAttribute("data-alert-id");
        }
    });

    // ìƒˆë¡œìš´ ì•Œë¦¼ì„ í…Œì´ë¸”ì— ì¶”ê°€
    function addNewAlertToTable(newAlert) {
        const tableBody = document.getElementById("coin-table");
        const row = document.createElement("tr");

        // ì½”ì¸ ì´ë¦„
        const coinNameCell = document.createElement("td");
        coinNameCell.textContent = newAlert.coinName;

        // ì•Œë¦¼ ê°€ê²©
        const alertPriceCell = document.createElement("td");
        alertPriceCell.textContent = `â‚©${newAlert.alertPrice.toLocaleString()}`; // ìˆ«ì í¬ë§· ì ìš©

        // ì•Œë¦¼ ì„¤ì • (ìŠ¤ìœ„ì¹˜)
        const alertActiveCell = document.createElement("td");
        const switchLabel = document.createElement("label");
        switchLabel.classList.add("switch");

        const switchInput = document.createElement("input");
        switchInput.type = "checkbox";
        switchInput.checked = newAlert.alertActive; // ì•Œë¦¼ í™œì„±í™” ì—¬ë¶€
        switchInput.setAttribute("data-alert-id", newAlert.alertId); // alertId ì €ì¥
        switchInput.setAttribute("data-alert-active", newAlert.alertActive); // alertId ì €ì¥

        const switchSpan = document.createElement("span");
        switchSpan.classList.add("slider", "round");

        switchLabel.appendChild(switchInput);
        switchLabel.appendChild(switchSpan);
        alertActiveCell.appendChild(switchLabel);

        // ìˆ˜ì • ë²„íŠ¼
        const editButton = document.createElement("button");
        editButton.textContent = "ìˆ˜ì •";
        editButton.classList.add("edit-button");
        editButton.setAttribute("data-alert-id", newAlert.alertId);

        // ì‚­ì œ ë²„íŠ¼
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "ì‚­ì œ";
        deleteButton.classList.add("delete-button");
        deleteButton.setAttribute("data-alert-id", newAlert.alertId);

        // ìˆ˜ì • ë²„íŠ¼ ì…€
        const editCell = document.createElement("td");
        editCell.appendChild(editButton);

        // ì‚­ì œ ë²„íŠ¼ ì…€
        const deleteCell = document.createElement("td");
        deleteCell.appendChild(deleteButton);

        // í…Œì´ë¸”ì— í–‰ ì¶”ê°€
        row.appendChild(coinNameCell);
        row.appendChild(alertPriceCell);
        row.appendChild(alertActiveCell);
        row.appendChild(editCell);
        row.appendChild(deleteCell);

        // í…Œì´ë¸”ì˜ ë§¨ ìœ„ì— í–‰ ì¶”ê°€
        if (tableBody.firstChild) {
            tableBody.insertBefore(row, tableBody.firstChild);
        } else {
            tableBody.appendChild(row);
        }

    }


    // ìˆ˜ì •ëœ ì•Œë¦¼ ì •ë³´ë¡œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updateAlertInTable(alertId, newAlertPrice) {
        const tableRows = document.querySelectorAll("#coin-table tr");

        tableRows.forEach(row => {
            const rowAlertId = row.querySelector(".edit-button").getAttribute("data-alert-id");
            if (rowAlertId === alertId) {
                //ê°€ê²© ì—…ë°ì´íŠ¸
                row.cells[1].textContent = `â‚©${newAlertPrice.toLocaleString()}`;
            }
        });
    }


    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.getElementById("coin-table").addEventListener("click", async function(event) {
        if (event.target.classList.contains("delete-button")) {
            const alertId = event.target.getAttribute("data-alert-id");

            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }

            try {
                const response = await fetch(`${backendBaseUrl}/api/alert/delete/${alertId}`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    credentials: "include"
                });

                const result = await response.json();

                if (result.result.code === "0000") {
                    alert("âœ… ì•Œë¦¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    event.target.closest("tr").remove(); // í…Œì´ë¸”ì—ì„œ í•´ë‹¹ í–‰ ì‚­ì œ
                    updateAlertCounts();
                } else {
                    alert("âš ï¸ ì•Œë¦¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error("âŒ ì•Œë¦¼ ì‚­ì œ ì˜¤ë¥˜:", error);
                alert("âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì¸í•´ ì•Œë¦¼ì„ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }
    });

    
    //ë¡œê·¸ì¸ í™•ì¸
    async function checkUserLogin() {
        try {
            //ë¡œì»¬
            //const response = await fetch('/api/user/email'); // ë°±ì—”ë“œì—ì„œ ì´ë©”ì¼ ê°€ì ¸ì˜¤ê¸°
            const response = await fetch(`${backendBaseUrl}/api/user/email`);

            const email = await response.text(); // ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜

            const userText = document.getElementById("user-email");
            const divider = document.querySelector(".divider");

            if (email.trim()) {
                // ë¡œê·¸ì¸ ìƒíƒœ â†’ ì´ë©”ì¼ í‘œì‹œ
                userText.textContent = email;
                if (divider) {
                    divider.style.display = "block"; // ë¡œê·¸ì¸ ìƒíƒœë©´ í‘œì‹œ
                }
            } else {
                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ â†’ ë¡œê·¸ì¸ ë²„íŠ¼ í™œì„±í™”
                userText.textContent = "";
                if (divider) {
                    divider.style.display = "none"; // ë¡œê·¸ì•„ì›ƒ ìƒíƒœë©´ ìˆ¨ê¹€
                }
            }
        } catch (error) {
            console.error("ğŸš¨ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    checkUserLogin(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
</script>

</body>
</html>